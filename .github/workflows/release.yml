name: NPM Publish

on:
  release:
    types: [published]

jobs:
  build:
    name: ðŸ—ï¸ Build for Publishing
    uses: ./.github/workflows/shared.yml
    with:
      upload-build: true

  publish:
    name: ðŸ“¤ Publish to NPM
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allow release editing
      id-token: write # Required for npm provenance
    environment: npm-publish # Optional: Use GitHub Environments for additional protection

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js for NPM
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "yarn"
          registry-url: "https://registry.npmjs.org"

      - name: ðŸ’¾ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: npm-build-${{ needs.build.outputs.package-version }}
          path: lib/

      - name: ðŸ“š Install production dependencies
        run: yarn install --frozen-lockfile --production

      - name: ðŸ” Verify release version
        run: |
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          RELEASE_VERSION=${RELEASE_TAG#v}

          echo "ðŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ðŸ·ï¸ Release: $RELEASE_TAG ($RELEASE_VERSION)"

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "âŒ Version mismatch:"
            echo "   package.json: $PACKAGE_VERSION"
            echo "   release tag:  $RELEASE_VERSION"
            exit 1
          fi

          echo "âœ… Version verification passed"

      - name: ðŸ” Final package verification
        run: |
          echo "ðŸ“‹ Final verification before publishing..."

          # Verify package structure
          if [ ! -d "lib" ]; then
            echo "âŒ Build directory missing"
            exit 1
          fi

          # Check if package already exists on npm
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          if npm view $PACKAGE_NAME@$PACKAGE_VERSION version 2>/dev/null; then
            echo "âš ï¸  Package $PACKAGE_NAME@$PACKAGE_VERSION already exists on npm"
            echo "âŒ Cannot publish duplicate version"
            exit 1
          fi

          echo "âœ… Package $PACKAGE_NAME@$PACKAGE_VERSION is ready for publishing"

          # Show what will be published
          echo "ðŸ“¦ Package contents:"
          npm pack --dry-run

      - name: ðŸ“¤ Publish to NPM
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          echo "ðŸš€ Publishing $PACKAGE_NAME@$PACKAGE_VERSION to npm..."

          npm publish --provenance --access public

          echo "âœ… Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸŽ‰ Publish Success
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          echo "ðŸŽ‰ Package published successfully!"
          echo "ðŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ðŸ”— NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
          echo "ðŸ“¥ Install: npm install $PACKAGE_NAME@$PACKAGE_VERSION"

      - name: ðŸ“Š Update Release with NPM Info
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          RELEASE_TAG=${GITHUB_REF#refs/tags/}

          # Get current release body
          CURRENT_BODY=$(gh release view $RELEASE_TAG --json body -q .body)

          # Create new release body with npm info
          cat > release_notes.md << EOF
          $CURRENT_BODY

          ## ðŸ“¤ Published to NPM

          âœ… **Successfully published to npm**

          ðŸ“¦ **Package:** [\`$PACKAGE_NAME@$PACKAGE_VERSION\`](https://www.npmjs.com/package/$PACKAGE_NAME)

          ðŸ“¥ **Install:**
          \`\`\`bash
          npm install $PACKAGE_NAME@$PACKAGE_VERSION
          \`\`\`
          EOF

          # Update release with new notes
          gh release edit $RELEASE_TAG --notes-file release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
