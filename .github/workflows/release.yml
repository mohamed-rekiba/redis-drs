name: NPM Publish

on:
  release:
    types: [published]

jobs:
  build:
    name: ğŸ—ï¸ Build for Publishing
    uses: ./.github/workflows/shared.yml
    with:
      upload-build: true

  publish:
    name: ğŸ“¤ Publish to NPM
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for npm provenance
    environment: npm-publish # Optional: Use GitHub Environments for additional protection

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js for NPM
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "yarn"
          registry-url: "https://registry.npmjs.org"

      - name: ğŸ’¾ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: npm-build-${{ needs.build.outputs.package-version }}
          path: lib/

      - name: ğŸ“š Install production dependencies
        run: yarn install --frozen-lockfile --production

      - name: ğŸ” Verify release version
        run: |
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          RELEASE_VERSION=${RELEASE_TAG#v}

          echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ğŸ·ï¸ Release: $RELEASE_TAG ($RELEASE_VERSION)"

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "âŒ Version mismatch:"
            echo "   package.json: $PACKAGE_VERSION"
            echo "   release tag:  $RELEASE_VERSION"
            exit 1
          fi

          echo "âœ… Version verification passed"

      - name: ğŸ” Final package verification
        run: |
          echo "ğŸ“‹ Final verification before publishing..."

          # Verify package structure
          if [ ! -d "lib" ]; then
            echo "âŒ Build directory missing"
            exit 1
          fi

          # Check if package already exists on npm
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          if npm view $PACKAGE_NAME@$PACKAGE_VERSION version 2>/dev/null; then
            echo "âš ï¸  Package $PACKAGE_NAME@$PACKAGE_VERSION already exists on npm"
            echo "âŒ Cannot publish duplicate version"
            exit 1
          fi

          echo "âœ… Package $PACKAGE_NAME@$PACKAGE_VERSION is ready for publishing"

          # Show what will be published
          echo "ğŸ“¦ Package contents:"
          npm pack --dry-run

      - name: ğŸ“¤ Publish to NPM
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          echo "ğŸš€ Publishing $PACKAGE_NAME@$PACKAGE_VERSION to npm..."

          npm publish --access public --provenance

          echo "âœ… Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ‰ Publish Success
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"

          echo "ğŸ‰ Package published successfully!"
          echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ğŸ”— NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
          echo "ğŸ“¥ Install: npm install $PACKAGE_NAME@$PACKAGE_VERSION"

      - name: ğŸ“Š Update Release with NPM Info
        run: |
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          RELEASE_TAG=${GITHUB_REF#refs/tags/}

          # Add npm info to release
          gh release edit $RELEASE_TAG \
            --notes-file - << EOF
          $(gh release view $RELEASE_TAG --json body -q .body)

          ## ğŸ“¤ Published to NPM

          âœ… **Successfully published to npm**

          ğŸ“¦ **Package:** [\`$PACKAGE_NAME@$PACKAGE_VERSION\`](https://www.npmjs.com/package/$PACKAGE_NAME)

          ğŸ“¥ **Install:**
          \`\`\`bash
          npm install $PACKAGE_NAME@$PACKAGE_VERSION
          \`\`\`
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
